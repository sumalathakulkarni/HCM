@{
    ViewData["Title"] = "Departments";
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
        <li class="breadcrumb-item active">Departments</li>
    </ol>
</nav>
<div class="container-fluid">
    <div class="alert alert-success" role="alert">
        <button type="button" id="btnAddDepartment" class="btn btn-primary"><i class="bi bi-plus-square-fill"></i>&nbsp;&nbsp;New Department</button>
    </div>
</div>

<div class="container-fluid">
    <div>
        <table id="tblDepartments" class="table table-striped table-hover" style="width:100%">
            <thead>
                <tr>
                    <th>Department ID</th>
                    <th>Department Name</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
        </table>
    </div>
</div>

@section scripts
{
    <script type="text/javascript">

        $(document).ready(function () {
            $(function () {
                // var bootstrapButton = $.fn.button.noConflict()
                // $.fn.bootstrapBtn = bootstrapButton;
                LoadDepartmentData();
            });
        });

        function LoadDepartmentData() {

            $.ajax({
                "type": "GET",
                "url": "/Department/GetAllDepartments",
                contentType: "application/json; charset=utf-8",
                datatype: "json",

                success: function (data) {

                    tblDepartments = $("#tblDepartments").DataTable({
                        "data": data,
                        scrollY: '400px',
                        scrollCollapse: true,
                        destroy: true,

                        "columnDefs": [
                            {
                                "targets": [0],
                                "data": "departmentID",
                                "searchable": false,
                                "orderable": false,
                            },
                            {
                                "targets": [1],
                                "data": "departmentName",
                                "className": "dt-left"
                            },
                            {
                                "targets": [2],
                                "data": null,
                                "orderable": false,
                                "searchable": false,
                                "defaultContent": '<a href="#" class="btn btn-sm btn-row" role="button" title="Edit" name="Edit" id="Edit"><i class="bi bi-pencil"></i></a>'
                            },
                            {
                                "targets": [3],
                                "data": null,
                                "orderable": false,
                                "searchable": false,
                                "defaultContent": '<a href="#" class="btn btn-sm btn-row" role="button" title="Delete" name="Delete" id="Delete"><i class="bi bi-trash"></i></a>'
                            }
                        ]
                    });

                    $('#btnAddDepartment').click(function (e) {

                        e.preventDefault();
                        $.ajax({
                            type: "GET",
                            url: "/Department/AddDepartment",
                            success: function (response) {
                                $('#dialog-view').html(response);
                                $("#dialog-view").dialog({
                                    title: "Add Department",
                                    resizable: false,
                                    height: "auto",
                                    width: 400,
                                    modal: true
                                });

                                $('#btnSaveNewDepartment').click(function (event) {

                                    event.preventDefault();
                                    var DepartmentID = 0;
                                    var DepartmentName = $("#DepartmentName").val();
                                    $.ajax({
                                        type: "POST",
                                        url: "/Department/SaveDepartment",
                                        data: { DepartmentID: DepartmentID, DepartmentName: DepartmentName },

                                        success: function (data) {
                                            $("#dialog-view").dialog("close");
                                            LoadDepartmentData();
                                            toastr.success('Department ' + DepartmentName + ' is Created', 'Confirmation');
                                        },
                                        error: function (ex) {
                                            alert('in error');
                                        }
                                    })
                                })
                            },
                            failure: function (response) {
                                alert(response.responseText);
                            },
                            error: function (response) {
                                alert(response.responseText);
                            }
                        });
                    });

                    $("#tblDepartments").on("click", ".btn-row", function (e) {
                    //$('#tblDepartments').find('a').click(function (e) {

                        var action = $(this).attr("Name");

                        var tr = $(this).closest('tr');
                        var row = tblDepartments.rows(tr);
                        var dept = row.data()[0];
                        // var deptID = row.data()[0].departmentID;
                        // var deptName = row.data()[0].departmentName;
                        // alert(deptID);
                        // alert(deptName);

                        if (action == "Edit") {
                            e.preventDefault();
                            $.ajax({
                                type: "POST",
                                url: "/Department/EditDepartment",
                                data: dept,
                                success: function (response) {
                                    $('#dialog-view').html(response);
                                    $("#dialog-view").dialog({
                                        title: "Edit Department",
                                        resizable: false,
                                        height: "auto",
                                        width: 400,
                                        modal: true
                                    });

                                    $('#btnSaveExistingDepartment').click(function (event) {

                                        event.preventDefault();
                                        var DepartmentID = $("#DepartmentID").val();
                                        var DepartmentName = $("#DepartmentName").val();
                                        $.ajax({
                                            type: "POST",
                                            url: "/Department/SaveDepartment",
                                            data: { DepartmentID: DepartmentID, DepartmentName: DepartmentName },

                                            success: function (data) {
                                                $("#dialog-view").dialog("close");
                                                LoadDepartmentData();
                                                toastr.success('Department ' + DepartmentName + ' is Updated', 'Confirmation');
                                            },
                                            error: function (ex) {
                                                alert('in error');
                                            }
                                        })
                                    })

                                },
                                failure: function (response) {
                                    alert(response.responseText);
                                },
                                error: function (response) {
                                    alert(response.responseText);
                                }
                            });
                        }
                        else if (action == "Delete") {
                            
                            e.preventDefault();
                            $("#dialog-confirm").html("<i style='color: red;' class='bi bi-exclamation-circle-fill'></i>&nbsp;&nbsp;Are you sure to delete the selected Department?");
                            $("#dialog-confirm").dialog({
                                
                                title: "Delete " + dept.departmentName,
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "Yes": function () {
                                        $.ajax({
                                            type: "POST",
                                            url: "/Department/DeleteDepartment?departmentId=" + dept.departmentID,
                                            success: function (response) {
                                                $("#dialog-confirm").dialog("close");
                                                LoadDepartmentData();
                                                toastr.success('Department ' + dept.departmentName + ' is Deleted', 'Confirmation');
                                            },
                                            failure: function (response) {
                                                alert(response.responseText);
                                            },
                                            error: function (response) {
                                                alert(response.responseText);
                                            }
                                        });
                                    },
                                    "No": function () {
                                        $("#dialog-confirm").dialog("close");
                                    }
                                }
                            });
                        }
                    });
                },
                error: function (ex) {
                    alert('in error');
                }
            });
        }
    </script>
}


